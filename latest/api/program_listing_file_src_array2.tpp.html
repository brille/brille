

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File array2.tpp &mdash; brille  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script>
        <script src="../_static/katex_autorenderer.js"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> brille
          

          
            
            <img src="../_static/brille.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User documents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install_guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../motivation.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../memory_usage.html">Memory Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">User Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">API documents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../brille.html">Python module <code class="docutils literal notranslate"><span class="pre">brille</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../brille.html#pybind11-module-brille-brille">pybind11 module <code class="docutils literal notranslate"><span class="pre">brille._brille</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting.html">Plotting utilities for <code class="docutils literal notranslate"><span class="pre">brille</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">C++ Library API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">brille</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Program Listing for File array2.tpp</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api/program_listing_file_src_array2.tpp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="program-listing-for-file-array2-tpp">
<span id="program-listing-file-src-array2-tpp"></span><h1>Program Listing for File array2.tpp<a class="headerlink" href="#program-listing-for-file-array2-tpp" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_src_array2.tpp.html#file-src-array2-tpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">src/array2.tpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">view</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="k">return</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span><span class="n">_num</span><span class="p">,</span><span class="n">_shift</span><span class="p">,</span><span class="n">_own</span><span class="p">,</span><span class="n">_ref</span><span class="p">,</span><span class="n">_shape</span><span class="p">,</span><span class="n">_stride</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">view</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
    <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
    <span class="n">ind_t</span> <span class="n">oshft</span><span class="p">{</span><span class="n">_shift</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">_stride</span><span class="p">[</span><span class="mi">0</span><span class="p">]};</span>
    <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">_num</span><span class="p">,</span> <span class="n">oshft</span><span class="p">,</span> <span class="n">_own</span><span class="p">,</span> <span class="n">_ref</span><span class="p">,</span> <span class="n">osize</span><span class="p">,</span> <span class="n">_stride</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2 index too large&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">view</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="o">&lt;=</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
    <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
    <span class="n">ind_t</span> <span class="n">oshft</span><span class="p">{</span><span class="n">_shift</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">_stride</span><span class="p">[</span><span class="mi">0</span><span class="p">]};</span>
    <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">_num</span><span class="p">,</span> <span class="n">oshft</span><span class="p">,</span> <span class="n">_own</span><span class="p">,</span> <span class="n">_ref</span><span class="p">,</span> <span class="n">osize</span><span class="p">,</span> <span class="n">_stride</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2 view indexing error&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">view</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">ind_t</span> <span class="n">oshft</span><span class="p">{</span><span class="n">_shift</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">osize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">oshft</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">_stride</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">_num</span><span class="p">,</span> <span class="n">oshft</span><span class="p">,</span> <span class="n">_own</span><span class="p">,</span> <span class="n">_ref</span><span class="p">,</span> <span class="n">osize</span><span class="p">,</span> <span class="n">_stride</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extract</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">decouple</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_integral_v</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extract</span><span class="p">(</span><span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">!=</span> <span class="n">i</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2 extraction requires (N,{1,...,1}) shape&quot;</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">i</span><span class="p">.</span><span class="n">valItr</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2 extract index must be in range&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">j</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">v</span><span class="p">:</span> <span class="n">i</span><span class="p">.</span><span class="n">valItr</span><span class="p">())</span> <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="p">)));</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_integral_v</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extract</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2 extract index must be in range&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">])));</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">Nel</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_integral_v</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extract</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="n">Nel</span><span class="o">&gt;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2 extract index must be in range&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Nel</span><span class="p">);</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">])));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// template&lt;class T&gt;</span>
<span class="c1">// template&lt;class I, size_t Nel&gt;</span>
<span class="c1">// std::enable_if_t&lt;std::is_integral_v&lt;I&gt;, Array&lt;T&gt;&gt;</span>
<span class="c1">// Array2&lt;T&gt;::extract(const std::vector&lt;std::array&lt;I,Nel&gt;&gt;&amp; i) const</span>
<span class="c1">// {</span>
<span class="c1">//   for (auto a: i) for (auto x: a) if (!(0 &lt;= x &amp;&amp; static_cast&lt;ind_t&gt;(x) &lt; _shape[0]))</span>
<span class="c1">//     throw std::runtime_error(&quot;Array2 extract index must be in range&quot;);</span>
<span class="c1">//   brille::shape_t osh{static_cast&lt;ind_t&gt;(i.size()), static_cast&lt;ind_t&gt;(Nel)};</span>
<span class="c1">//   for (ind_t i=1; i&lt;this-&gt;ndim(); ++i)</span>
<span class="c1">//     osh.push_back(_shape[i]);</span>
<span class="c1">//   Array&lt;T&gt; out(osh);</span>
<span class="c1">//   shape_t xi{_shape};</span>
<span class="c1">//   for (ind_t a=0; a&lt;i.size(); ++a)</span>
<span class="c1">//   {</span>
<span class="c1">//     osh[0] = a;</span>
<span class="c1">//     for (ind_t b=0; b&lt;Nel; ++b)</span>
<span class="c1">//     {</span>
<span class="c1">//       osh[1] = b;</span>
<span class="c1">//       xi[0] = static_cast&lt;ind_t&gt;(i[a][b]);</span>
<span class="c1">//       for (auto sub: SubIt2(_shape, xi))</span>
<span class="c1">//       {</span>
<span class="c1">//         for (ind_t j=0; j&lt;_shape.size(); ++j) osh[j+1]=sub[j];</span>
<span class="c1">//         out[sub] = _data[this-&gt;s2l_d(xi)];</span>
<span class="c1">//       }</span>
<span class="c1">//     }</span>
<span class="c1">//   }</span>
<span class="c1">//   return out;</span>
<span class="c1">// }</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extract</span><span class="p">(</span><span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">shape_t</span> <span class="n">isize</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">shape</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Boolean Array2 extraction requires no more bools than the first Array2 dimension&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">isize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">isize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">ind_t</span> <span class="n">idx</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">idx</span><span class="o">++</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extract</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Boolean Array2 extraction requires no more bools than the first Array2 dimension&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">count</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">i</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="nb">true</span><span class="p">);</span>
  <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">i</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">:</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">ind_t</span> <span class="n">idx</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">idx</span><span class="o">++</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">j</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">in</span><span class="p">){</span>
  <span class="c1">// we might be able to do this better/faster if we both *this and in</span>
  <span class="c1">// have the same strides_ and we account for any offset. For now calculate</span>
  <span class="c1">// the &#39;hard&#39; way no matter what:</span>
  <span class="n">shape_t</span> <span class="n">inshape</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">shape</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">inshape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Set requires equal dimensions beyond the first dimension&quot;</span><span class="p">);</span>
  <span class="n">inshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span> <span class="c1">// this *should* be the case anyway</span>
  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">sub</span><span class="p">:</span> <span class="n">SubIt2</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inshape</span><span class="p">)){</span>
    <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">sub</span><span class="p">];</span>
    <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [0,0,…,0],[0,0,…,1],…,[0,1,…,0],… to [i,0,…,0],[i,0,…,1],…,[i,1,…,0],…</span>
    <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;&amp;</span> <span class="n">in</span><span class="p">){</span>
  <span class="c1">// we might be able to do this better/faster if we both *this and in</span>
  <span class="c1">// have the same strides_ and we account for any offset. For now calculate</span>
  <span class="c1">// the &#39;hard&#39; way no matter what:</span>
  <span class="n">shape_t</span> <span class="n">inshape</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">shape</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">inshape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Set requires equal dimensions beyond the first dimension&quot;</span><span class="p">);</span>
  <span class="n">inshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span> <span class="c1">// this *should* be the case anyway</span>
  <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">sub</span><span class="p">:</span> <span class="n">SubIt2</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inshape</span><span class="p">)){</span>
    <span class="k">const</span> <span class="n">R</span><span class="o">&amp;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">sub</span><span class="p">];</span>
    <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [0,0,…,0],[0,0,…,1],…,[0,1,…,0],… to [i,0,…,0],[i,0,…,1],…,[i,1,…,0],…</span>
    <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">)]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">in</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">in</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Set requires the correct number of elements&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">tsize</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>
  <span class="n">tsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="c1">// in is (hopefully) a row-ordered linear indexing</span>
  <span class="kt">size_t</span> <span class="n">idx</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">sub</span><span class="p">:</span> <span class="n">SubIt2</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tsize</span><span class="p">)){</span>
    <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">)]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="kt">size_t</span> <span class="n">Nel</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Nel</span><span class="o">&gt;&amp;</span> <span class="n">in</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Nel</span><span class="p">)</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Set requires the correct number of elements&quot;</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">tsize</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>
  <span class="n">tsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="c1">// in is (hopefully) a row-ordered linear indexing</span>
  <span class="kt">size_t</span> <span class="n">idx</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">sub</span><span class="p">:</span> <span class="n">SubIt2</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tsize</span><span class="p">)){</span>
    <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">)]</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">sub</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">in</span><span class="p">){</span>
  <span class="k">auto</span> <span class="n">ind</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">);</span>
  <span class="n">_data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">ind</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">to_string</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Unallocated Array2&quot;</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">width</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="kt">size_t</span> <span class="n">l</span> <span class="o">=</span> <span class="n">my_to_string</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="n">i</span><span class="p">]).</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">)</span> <span class="n">width</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">out</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">isin</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">preamble</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>
  <span class="kt">size_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">sub</span><span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">()){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preamble</span><span class="p">){</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isin</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
        <span class="n">isin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
      <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;[&quot;</span><span class="p">;</span> <span class="c1">// for i=ndim-1;</span>
      <span class="n">preamble</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">out</span> <span class="o">+=</span> <span class="n">my_to_string</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">)],</span> <span class="n">width</span><span class="p">);</span>
    <span class="c1">// out += std::to_string(_data[this-&gt;s2l_d(sub)]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">]){</span>
      <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
        <span class="kt">bool</span> <span class="n">isend</span><span class="p">{</span><span class="nb">true</span><span class="p">};</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">ndim</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="n">isend</span> <span class="o">&amp;=</span> <span class="n">sub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">_shape</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isend</span><span class="p">){</span>
          <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
          <span class="n">isin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;],&quot;</span><span class="p">;</span> <span class="c1">// &#39;]&#39; for i=ndim-1;</span>
      <span class="kt">size_t</span> <span class="n">nret</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">count</span><span class="p">(</span><span class="n">isin</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">isin</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">nret</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="n">preamble</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndim</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">out</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span> <span class="c1">// remove the trailing &#39;\n&#39;s</span>
  <span class="n">out</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span> <span class="c1">// and the trailing ,</span>
  <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">to_string</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">out</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">to_string</span><span class="p">();</span>
  <span class="n">out</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span> <span class="c1">// remove the trailing \n</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">reshape</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">ns</span><span class="p">){</span>
  <span class="n">ind_t</span> <span class="n">num</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_from_shape</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
  <span class="n">info_update_if</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">_num</span><span class="p">,</span> <span class="s">&quot;Array2::reshape only intended for equal-element number changes.&quot;</span><span class="p">);</span>
  <span class="c1">// assert( num &lt;= _num );</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">is_contiguous</span><span class="p">())</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Array2::reshape does not work for strided arrays&quot;</span><span class="p">);</span>
  <span class="n">_shape</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
  <span class="n">_stride</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*! \brief Modify the number of arrays</span>

<span class="cm">Allocate a new T* and copy the overlapping region. The new shape</span>
<span class="cm">*must* have the same number of dimensions as the old shape.</span>

<span class="cm">Resizing an array will decouple it from any other arrays sharing their</span>
<span class="cm">underlying data. Such an operation should not be taken lightly.</span>

<span class="cm">@param ns the new shape</span>
<span class="cm">@param init an optional initialization value for any non-overlapping region</span>
<span class="cm">*/</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">resize</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">ns</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">init</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">nnum</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_from_shape</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
  <span class="c1">// determine which axes are changing and how</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">shrinking</span><span class="p">,</span> <span class="n">growing</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ns</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="n">shrinking</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">growing</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">shrink</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">all_of</span><span class="p">(</span><span class="n">shrinking</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">shrinking</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[](</span><span class="kt">bool</span> <span class="n">a</span><span class="p">){</span><span class="k">return</span> <span class="n">a</span><span class="p">;});</span>
  <span class="kt">bool</span> <span class="n">grow</span> <span class="o">=</span> <span class="o">!</span><span class="n">shrink</span> <span class="o">&amp;&amp;</span> <span class="n">std</span><span class="o">::</span><span class="n">all_of</span><span class="p">(</span><span class="n">growing</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">growing</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[](</span><span class="kt">bool</span> <span class="n">a</span><span class="p">){</span><span class="k">return</span> <span class="n">a</span><span class="p">;});</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shrink</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">grow</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;This method is not able to resize from { &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="n">_shape</span><span class="p">)</span> <span class="n">msg</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;} to { &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="n">ns</span><span class="p">)</span> <span class="n">msg</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// make the new array</span>
  <span class="n">T</span><span class="o">*</span> <span class="n">nd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">[</span><span class="n">nnum</span><span class="p">]();</span>
  <span class="c1">// fill the whole thing instead of trying to figure out difference indices</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">grow</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">nd</span><span class="o">+</span><span class="n">nnum</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
  <span class="c1">// loop over the subscripted incides which fit inside both arrays</span>
  <span class="n">shape_t</span> <span class="n">inside</span> <span class="o">=</span> <span class="n">shrink</span> <span class="o">?</span> <span class="nl">ns</span> <span class="p">:</span> <span class="n">_shape</span><span class="p">;</span>
  <span class="c1">// find the new stride (maintaining row or column order)</span>
  <span class="n">shape_t</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">calculate_stride</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
  <span class="c1">// ensure our simple indexing will work</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Resizing only works for zero-offset Array2s at present. Please extend.&quot;</span><span class="p">);</span>
  <span class="c1">// copy into the new array if the old array isn&#39;t the null pointer</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_data</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">nd</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="n">SubIt2</span><span class="p">(</span><span class="n">inside</span><span class="p">))</span> <span class="n">nd</span><span class="p">[</span><span class="n">sub2lin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">sub2lin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_stride</span><span class="p">)];</span>
  <span class="c1">// delete the old _data if we hold the only reference</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_own</span> <span class="o">&amp;&amp;</span> <span class="n">_ref</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">_data</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">delete</span><span class="p">[]</span> <span class="n">_data</span><span class="p">;</span>
  <span class="c1">// update data, number, ownership, reference, size, stride, and mutability</span>
  <span class="n">_data</span> <span class="o">=</span> <span class="n">nd</span><span class="p">;</span>
  <span class="n">_num</span> <span class="o">=</span> <span class="n">nnum</span><span class="p">;</span>
  <span class="n">_own</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">_ref</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">();</span> <span class="c1">// resizing in place can not change the template parameter</span>
  <span class="n">_shape</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
  <span class="n">_stride</span> <span class="o">=</span> <span class="n">nt</span><span class="p">;</span>
  <span class="n">_mutable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="c1">// pass back a reference to this object</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">resize</span><span class="p">(</span><span class="k">const</span> <span class="n">I</span> <span class="n">ns</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">init</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">shape_t</span> <span class="n">nshape</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nshape</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Resizing a null-shaped Array2 not supported (yet)&quot;</span><span class="p">);</span>
    <span class="c1">//nshape.push_back(static_cast&lt;ind_t&gt;(ns));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">(</span><span class="n">nshape</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">dim</span><span class="p">,</span> <span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="k">this</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">extra</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dim</span><span class="o">&lt;</span><span class="n">ndim</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">eshape</span> <span class="o">=</span> <span class="n">extra</span><span class="p">.</span><span class="n">shape</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndim</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="n">dim</span> <span class="o">&amp;&amp;</span> <span class="n">eshape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Incompatible Array2 to append&quot;</span><span class="p">);</span>
  <span class="c1">// the new expanded size only changes along dim</span>
  <span class="n">eshape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">];</span>
  <span class="c1">// stash this original shape along dim for use in the loop:</span>
  <span class="n">ind_t</span> <span class="n">tshapedim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">];</span>
  <span class="c1">// and resizing the Array2 to the new size copies existing entries</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">(</span><span class="n">eshape</span><span class="p">);</span>
  <span class="c1">// so we need only iterate over the extra Array2</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="n">SubIt2</span><span class="p">(</span><span class="n">extra</span><span class="p">.</span><span class="n">shape</span><span class="p">())){</span>
    <span class="c1">// offsetting its subscript to the new position</span>
    <span class="k">auto</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">y</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tshapedim</span><span class="p">;</span> <span class="c1">// offset by the original shape along the dimension</span>
    <span class="c1">// and copying the contents</span>
    <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">all</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">nml</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">nml</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">nml</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">any</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">nml</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">nml</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">nml</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">all</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">nml</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">nml</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">nml</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">any</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">nml</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">nml</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">nml</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">count</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">el</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">el</span><span class="p">;</span>
  <span class="n">ind_t</span> <span class="n">count</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="o">++</span><span class="n">count</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">count</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">el</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">el</span><span class="p">;</span>
  <span class="n">ind_t</span> <span class="n">count</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="o">++</span><span class="n">count</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">first</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">el</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">el</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">no</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">first</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">el</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">el</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">no</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">last</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">el</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">el</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="n">no</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="k">if</span> <span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">no</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">last</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">el</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">)</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">el</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="n">no</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">no</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ARRAY_ELEMENTWISE_INT_TRANSFORM(X) template&lt;class T&gt;\</span>
<span class="cp">Array2&lt;int&gt;\</span>
<span class="cp">Array2&lt;T&gt;:: X () const {\</span>
<span class="cp">  Array2&lt;int&gt; out(_shape, _stride);\</span>
<span class="cp">  for (auto x: out.subItr())\</span>
<span class="cp">    out[x] = static_cast&lt;int&gt;(std:: X (_data[this-&gt;s2l_d(x)]));\</span>
<span class="cp">  return out;\</span>
<span class="cp">}</span>
<span class="n">ARRAY_ELEMENTWISE_INT_TRANSFORM</span><span class="p">(</span><span class="n">round</span><span class="p">)</span>
<span class="n">ARRAY_ELEMENTWISE_INT_TRANSFORM</span><span class="p">(</span><span class="n">floor</span><span class="p">)</span>
<span class="n">ARRAY_ELEMENTWISE_INT_TRANSFORM</span><span class="p">(</span><span class="n">ceil</span><span class="p">)</span>
<span class="cp">#undef ARRAY_ELEMENTWISE_INT_TRANSFORM</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">sum</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">dim</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="n">ndim</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>
  <span class="n">osize</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="n">shape_t</span> <span class="n">ostride</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span> <span class="c1">// preserve orderness</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">,</span> <span class="n">ostride</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">oidx</span><span class="p">:</span> <span class="n">out</span><span class="p">.</span><span class="n">subItr</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">T</span> <span class="n">tmp</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">oidx</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">idx</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">tmp</span> <span class="o">+=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">idx</span><span class="p">)];</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">[</span><span class="n">oidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">prod</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">dim</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="n">ndim</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>
  <span class="n">osize</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="n">shape_t</span> <span class="n">ostride</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span> <span class="c1">// preserve orderness</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">,</span> <span class="n">ostride</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">oidx</span><span class="p">:</span> <span class="n">out</span><span class="p">.</span><span class="n">subItr</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">T</span> <span class="n">tmp</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
    <span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">oidx</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">idx</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">tmp</span> <span class="o">*=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">idx</span><span class="p">)];</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">[</span><span class="n">oidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">dim</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="n">ndim</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>
  <span class="n">osize</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="n">shape_t</span> <span class="n">ostride</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span> <span class="c1">// preserve orderness</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">,</span> <span class="n">ostride</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">oidx</span><span class="p">:</span> <span class="n">out</span><span class="p">.</span><span class="n">subItr</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">T</span> <span class="n">tmp</span><span class="p">{(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">)()};</span>
    <span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">oidx</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">idx</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">T</span> <span class="n">tst</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">idx</span><span class="p">)];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tst</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tst</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">[</span><span class="n">oidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">dim</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="n">ndim</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">();</span>
  <span class="n">osize</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="n">shape_t</span> <span class="n">ostride</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">osize</span><span class="p">);</span> <span class="c1">// preserve orderness</span>
  <span class="c1">// the stride along any dimension can not be zero. protect against it:</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndim</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">ostride</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="n">ostride</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>

  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">,</span> <span class="n">ostride</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">oidx</span><span class="p">:</span> <span class="n">out</span><span class="p">.</span><span class="n">subItr</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">T</span> <span class="n">tmp</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">lowest</span><span class="p">()};</span>
    <span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">oidx</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">idx</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">T</span> <span class="n">tst</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">idx</span><span class="p">)];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tst</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tst</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">[</span><span class="n">oidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">sum</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">T</span> <span class="n">out</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">())</span> <span class="n">out</span> <span class="o">+=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">x</span><span class="p">)];</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">prod</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">T</span> <span class="n">out</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">())</span> <span class="n">out</span> <span class="o">*=</span> <span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">x</span><span class="p">)];</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">Nel</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">match</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="n">Nel</span><span class="o">&gt;&amp;</span> <span class="n">rot</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2u</span><span class="p">);</span> <span class="c1">// only defined for 2-D Array2s</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">Nel</span> <span class="o">==</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">ind_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">T</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="n">tmp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">eq</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">eq</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">o</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">do</span><span class="p">{</span>
      <span class="c1">//check against the current tmp vector whether this order rotation has moved j to i</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">1u</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
      <span class="c1">// otherwise apply the rotation (again)</span>
      <span class="n">brille</span><span class="o">::</span><span class="n">utils</span><span class="o">::</span><span class="n">mul_mat_vec_inplace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rot</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">o</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">order</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// rotate exactly order times</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">o</span><span class="o">&lt;</span><span class="n">order</span><span class="p">;</span> <span class="o">++</span><span class="n">o</span><span class="p">)</span>
      <span class="n">brille</span><span class="o">::</span><span class="n">utils</span><span class="o">::</span><span class="n">mul_mat_vec_inplace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rot</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
    <span class="k">return</span> <span class="nf">eq</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">1u</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">match</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j</span><span class="p">,</span> <span class="n">brille</span><span class="o">::</span><span class="n">ops</span> <span class="n">op</span><span class="p">,</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">ai</span><span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">aj</span><span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">neq</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">neq</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">()</span><span class="o">/</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">){</span>
    <span class="k">case</span> <span class="n">brille</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="nl">plus</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">neq</span><span class="p">(</span><span class="n">ai</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">aj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">brille</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="nl">minus</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">neq</span><span class="p">(</span><span class="n">ai</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">aj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">brille</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="nl">times</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">neq</span><span class="p">(</span><span class="n">ai</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">aj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">brille</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="nl">rdiv</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">neq</span><span class="p">(</span><span class="n">ai</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">aj</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">brille</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="nl">ldiv</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">neq</span><span class="p">(</span><span class="n">ai</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">val</span><span class="o">/</span><span class="n">aj</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;Unhandled operator &quot;</span><span class="p">)</span><span class="o">+</span><span class="n">brille</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">op</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">all</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">le_ge</span> <span class="o">==</span> <span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">le</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">all</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">ge</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">any</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">first</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="n">k</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">no</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">last</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="n">no</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">;)</span> <span class="k">if</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">val</span><span class="p">))</span> <span class="k">return</span> <span class="n">k</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">no</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ind_t</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">count</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">cnt</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">val</span><span class="p">))</span> <span class="o">++</span><span class="n">cnt</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_stride</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">l2l_d</span><span class="p">(</span><span class="n">k</span><span class="p">)],</span> <span class="n">val</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">find</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">this_is</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">is</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">no</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">numel</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">no</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">this_is</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;&amp;</span> <span class="n">that</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// To handle singleton-dimension broadcasting, this function needs to be split</span>
  <span class="k">auto</span> <span class="n">tsize</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">shape</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">equal</span><span class="p">(</span><span class="n">_shape</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">_shape</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">tsize</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
      <span class="p">[](</span><span class="n">ind_t</span> <span class="n">a</span><span class="p">,</span> <span class="n">ind_t</span> <span class="n">b</span><span class="p">){</span><span class="k">return</span> <span class="mi">1</span><span class="o">==</span><span class="n">b</span> <span class="o">||</span> <span class="n">a</span><span class="o">==</span><span class="n">b</span><span class="p">;})){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;An Array2 with size ( &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">tsize</span><span class="p">)</span> <span class="n">msg</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;) can not be broadcast to match one with size ( &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">_shape</span><span class="p">)</span> <span class="n">msg</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;).&quot;</span><span class="p">;</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_stride</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">equal</span><span class="p">(</span><span class="n">_shape</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">_shape</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">tsize</span><span class="p">.</span><span class="n">begin</span><span class="p">())){</span>
    <span class="c1">// No broadcast</span>
    <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
    <span class="c1">// no guarantees about same stride, so use subscript iterator:</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">sub</span><span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">())</span> <span class="n">out</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">sub</span><span class="p">)],</span> <span class="n">that</span><span class="p">[</span><span class="n">sub</span><span class="p">]);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Broadcast</span>
    <span class="kt">size_t</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ndim</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">tsize</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Broadcasting beyond the first dimension requires viewing beyond the first dimension!&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">is</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">that</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is</span><span class="p">(</span><span class="k">const</span> <span class="n">brille</span><span class="o">::</span><span class="n">cmp</span> <span class="n">expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">;</span>
  <span class="n">out</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">1u</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is</span><span class="p">(</span><span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;&amp;</span> <span class="n">that</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">is</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">eq</span><span class="p">,</span> <span class="n">that</span><span class="p">).</span><span class="n">all</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_unique</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="n">out</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">neq</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">sz</span><span class="p">{</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">st</span><span class="p">{</span><span class="n">_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="kt">bool</span> <span class="n">isu</span><span class="p">{</span><span class="nb">true</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">){</span>
      <span class="n">isu</span> <span class="o">&amp;=</span> <span class="n">op</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">st</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">st</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isu</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">isu</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">unique_idx</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1u</span><span class="p">)</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="mi">0u</span><span class="p">);</span>
  <span class="n">out</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">Comparer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">cmp</span><span class="o">::</span><span class="n">eq</span><span class="p">);</span>
  <span class="n">ind_t</span> <span class="n">sz</span><span class="p">{</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">st</span><span class="p">{</span><span class="n">_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="n">ind_t</span> <span class="n">idx</span><span class="p">{</span><span class="n">i</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">op</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">st</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">st</span><span class="p">)){</span>
      <span class="n">idx</span><span class="o">=</span><span class="n">j</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">unique</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">isu</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">is_unique</span><span class="p">();</span>
  <span class="kt">size_t</span> <span class="n">u_count</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">count</span><span class="p">(</span><span class="n">isu</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">isu</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="nb">true</span><span class="p">);</span>
  <span class="n">shape_t</span> <span class="n">osize</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">osize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ind_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u_count</span><span class="p">);</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">osize</span><span class="p">,</span> <span class="n">_stride</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">isu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">out</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">u</span><span class="o">++</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">dot</span><span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind_t</span> <span class="n">j</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">j</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">ind_t</span> <span class="n">sz</span><span class="p">{</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> <span class="n">st</span><span class="p">{</span><span class="n">_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">prods</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">brille</span><span class="o">::</span><span class="n">RawBinaryOperator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">prod</span><span class="p">(</span><span class="n">brille</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">times</span><span class="p">);</span>
  <span class="c1">// perform elementwise multiplication on the views of i and j</span>
  <span class="n">prod</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">prods</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">1u</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">st</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">st</span><span class="p">);</span>
  <span class="c1">// find the sum of the products</span>
  <span class="c1">// std::reduce can do this in parallel but gcc&lt;v9.3 does not implement all of C++17</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">prods</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">prods</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">T</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">norm</span><span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">-</span><span class="p">()</span> <span class="k">const</span><span class="p">{</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">neg</span><span class="p">(</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_stride</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">s</span><span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">())</span> <span class="n">neg</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">_data</span><span class="p">[</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">s</span><span class="p">)];</span>
  <span class="k">return</span> <span class="n">neg</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="p">,</span> <span class="k">typename</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">permute</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&amp;</span> <span class="n">p</span><span class="p">){</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">(</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">iota</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">o</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="mi">0u</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="n">debug_update_if</span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">includes</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">o</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">s</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">s</span><span class="p">.</span><span class="n">end</span><span class="p">()),</span><span class="s">&quot;The permutation vector &quot;</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="s">&quot; is invalid. Expected permutation of &quot;</span><span class="p">,</span><span class="n">o</span><span class="p">);</span>
  <span class="c1">// get the inverse permutation to enable element swapping:</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">p</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">s</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="c1">// perform the swaps until we have no more to do:</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">i</span><span class="p">){</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">swap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>
    <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
      <span class="o">++</span><span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">debug_update_if</span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_sorted</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">s</span><span class="p">.</span><span class="n">end</span><span class="p">()),</span> <span class="s">&quot;Undoing the permutation &quot;</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="s">&quot; failed. End result is &quot;</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">swap</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">b</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">shape_t</span> <span class="n">sub</span><span class="p">{</span><span class="n">_shape</span><span class="p">};</span>
  <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="c1">// fix the 0th index to &#39;a&#39; in the iterator</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">aidx</span><span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">(</span><span class="n">sub</span><span class="p">)){</span>
    <span class="c1">// for each of the [a,...] subscripted indices, construct [b,...]</span>
    <span class="n">shape_t</span> <span class="n">bidx</span><span class="p">{</span><span class="n">aidx</span><span class="p">};</span>
    <span class="n">bidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="c1">// precalculate the offset/stride/shaped subscripts:</span>
    <span class="k">auto</span> <span class="n">sa</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">aidx</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">bidx</span><span class="p">);</span>
    <span class="c1">// perform the actual swap:</span>
    <span class="n">T</span> <span class="n">_store_</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">sa</span><span class="p">];</span>
    <span class="n">_data</span><span class="p">[</span><span class="n">sa</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">sb</span><span class="p">];</span>
    <span class="n">_data</span><span class="p">[</span><span class="n">sb</span><span class="p">]</span> <span class="o">=</span> <span class="n">_store_</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">swap</span><span class="p">(</span><span class="n">ind_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind_t</span> <span class="n">a</span><span class="p">,</span> <span class="n">ind_t</span> <span class="n">b</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">auto</span> <span class="n">la</span><span class="p">{</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">ij2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">)},</span> <span class="n">lb</span><span class="p">{</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">ij2l_d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">)};</span>
  <span class="n">T</span> <span class="n">_store_</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">la</span><span class="p">];</span>
  <span class="n">_data</span><span class="p">[</span><span class="n">la</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">lb</span><span class="p">];</span>
  <span class="n">_data</span><span class="p">[</span><span class="n">lb</span><span class="p">]</span> <span class="o">=</span> <span class="n">_store_</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">to_std</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">valItr</span><span class="p">())</span> <span class="n">out</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">*</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span> <span class="o">+</span> <span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">0u</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">*</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j0</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span> <span class="o">+</span> <span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">*</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span> <span class="o">+</span> <span class="n">s2l_d</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span> <span class="o">+</span> <span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">0u</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span> <span class="o">+</span> <span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span> <span class="o">+</span> <span class="n">s2l_d</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">0u</span><span class="p">)];</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j0</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">)];</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">){</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">p</span><span class="p">)];</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">initializer_list</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="n">l</span><span class="p">){</span>
  <span class="n">shape_t</span> <span class="n">idx</span><span class="p">{</span><span class="n">l</span><span class="p">};</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">0u</span><span class="p">)];</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="k">const</span> <span class="n">ind_t</span> <span class="n">i0</span><span class="p">,</span> <span class="k">const</span> <span class="n">ind_t</span> <span class="n">j0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">i0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j0</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">ij2l_d</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">)];</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="k">const</span> <span class="n">shape_t</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">s2l_d</span><span class="p">(</span><span class="n">p</span><span class="p">)];</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="o">&gt;</span>
<span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">val</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">initializer_list</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span> <span class="n">l</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">shape_t</span> <span class="n">idx</span><span class="p">{</span><span class="n">l</span><span class="p">};</span>
  <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">contiguous_copy</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">is_contiguous</span><span class="p">())</span> <span class="k">return</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">_shape</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">_shape</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">())</span> <span class="n">out</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)[</span><span class="n">x</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">contiguous_row_ordered_copy</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">is_row_ordered</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">is_contiguous</span><span class="p">())</span> <span class="k">return</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">(</span><span class="n">_shape</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">calculate_stride</span><span class="p">(</span><span class="n">_shape</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span> <span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">subItr</span><span class="p">())</span> <span class="n">out</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)[</span><span class="n">x</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mutable_check</span><span class="p">(</span><span class="k">const</span> <span class="n">Array2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">a</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">.</span><span class="n">ismutable</span><span class="p">())</span>
  <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Immutable Array2 objects can not be modified!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SCALAR_INPLACE_OP(X) template&lt;class T&gt;\</span>
<span class="cp">Array2&lt;T&gt;&amp; Array2&lt;T&gt;::operator X (const T&amp; val){\</span>
<span class="cp">  mutable_check(*this);\</span>
<span class="cp">  for (auto&amp; v: this-&gt;valItr()) v X val;\</span>
<span class="cp">  return *this;\</span>
<span class="cp">}</span>
<span class="n">SCALAR_INPLACE_OP</span><span class="p">(</span><span class="o">+=</span><span class="p">)</span>
<span class="n">SCALAR_INPLACE_OP</span><span class="p">(</span><span class="o">-=</span><span class="p">)</span>
<span class="n">SCALAR_INPLACE_OP</span><span class="p">(</span><span class="o">*=</span><span class="p">)</span>
<span class="n">SCALAR_INPLACE_OP</span><span class="p">(</span><span class="o">/=</span><span class="p">)</span>
<span class="cp">#undef SCALAR_INPLACE_OP</span>
<span class="c1">// template&lt;class T&gt;</span>
<span class="c1">// Array2&lt;T&gt;&amp;</span>
<span class="c1">// Array2&lt;T&gt;::operator+=(const T&amp; val){</span>
<span class="c1">//   mutable_check(*this);</span>
<span class="c1">//   for (auto&amp; v: this-&gt;valItr()) v += val;</span>
<span class="c1">//   return *this;</span>
<span class="c1">// }</span>
<span class="c1">// template&lt;class T&gt;</span>
<span class="c1">// Array2&lt;T&gt;&amp;</span>
<span class="c1">// Array2&lt;T&gt;::operator-=(const T&amp; val){</span>
<span class="c1">//   mutable_check(*this);</span>
<span class="c1">//   for (auto&amp; v: this-&gt;valItr()) v -= val;</span>
<span class="c1">//   return *this;</span>
<span class="c1">// }</span>
<span class="c1">// template&lt;class T&gt;</span>
<span class="c1">// Array2&lt;T&gt;&amp;</span>
<span class="c1">// Array2&lt;T&gt;::operator*=(const T&amp; val){</span>
<span class="c1">//   mutable_check(*this);</span>
<span class="c1">//   auto itr = this-&gt;valItr();</span>
<span class="c1">//   for (auto &amp; v: itr){</span>
<span class="c1">//     v *= val;</span>
<span class="c1">//   }</span>
<span class="c1">//   return *this;</span>
<span class="c1">// }</span>
<span class="c1">// template&lt;class T&gt;</span>
<span class="c1">// Array2&lt;T&gt;&amp;</span>
<span class="c1">// Array2&lt;T&gt;::operator/=(const T&amp; val){</span>
<span class="c1">//   mutable_check(*this);</span>
<span class="c1">//   for (auto&amp; v: this-&gt;valItr()) v /= val;</span>
<span class="c1">//   return *this;</span>
<span class="c1">// }</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">broadcast_shape_check</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="n">b</span><span class="p">){</span>
  <span class="kt">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;In place broadcasting is not possible for { &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">a</span><span class="p">)</span> <span class="n">msg</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;} shaped Array2 and { &quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">x</span><span class="p">:</span> <span class="n">b</span><span class="p">)</span> <span class="n">msg</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;} shaped operand&quot;</span><span class="p">;</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ARRAY_INPLACE_OP(X) template&lt;class T&gt; template&lt;class R&gt;\</span>
<span class="cp">Array2&lt;T&gt;&amp; Array2&lt;T&gt;::operator X (const Array2&lt;R&gt;&amp; val){\</span>
<span class="cp">  mutable_check(*this);\</span>
<span class="cp">  auto itr = this-&gt;broadcastItr(val);\</span>
<span class="cp">  broadcast_shape_check(_shape, itr.shape());\</span>
<span class="cp">  for (auto [ox, tx, vx]: itr) _data[this-&gt;s2l_d(tx)] X val[vx];\</span>
<span class="cp">  return *this;\</span>
<span class="cp">}</span>
<span class="n">ARRAY_INPLACE_OP</span><span class="p">(</span><span class="o">+=</span><span class="p">)</span>
<span class="n">ARRAY_INPLACE_OP</span><span class="p">(</span><span class="o">-=</span><span class="p">)</span>
<span class="n">ARRAY_INPLACE_OP</span><span class="p">(</span><span class="o">*=</span><span class="p">)</span>
<span class="n">ARRAY_INPLACE_OP</span><span class="p">(</span><span class="o">/=</span><span class="p">)</span>
<span class="cp">#undef ARRAY_INPLACE_OP</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Gregory Tucker

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>